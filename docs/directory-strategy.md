# ディレクトリ戦略

本ドキュメントでは、各ディレクトリの役割と、その中に含まれるモジュール・ファイルの責務について説明します。
また、ドメイン層、アプリケーション層、インフラストラクチャ層というレイヤー分離の思想と依存性の方向性についても記述しています。

---

## ディレクトリ構成の全体像(2025/02/10更新)

```
.
├── application
│   ├── commands
│   ├── controllers
│   ├── events
│   ├── repository
│   ├── tasks
│   └── usecases
├── domain
│   ├── entities
│   ├── roles
│   └── types
├── infrastructure
├── main.ts
├── scripts
│   ├── deployCommands.ts
│   └── loadCommands.ts
└── utils
```

---

## 各ディレクトリの役割

### 1. application

**概要:**
アプリケーション層は、ユースケース（ビジネスロジックの調整）や外部インターフェース（コントローラー、コマンド、イベントハンドラなど）をまとめた層です。
ここでは、ユーザーや Discord とのインタラクションに応じた処理、また外部システムへの入力／出力の調整が行われます。

**含まれるサブディレクトリ:**

- **commands**
  Discord Bot に対して実装する各コマンドを格納します。
  1 コマンドにつき 1 ファイルとして実装し、Bot の動作（例：登録、認証、情報取得など）を担当します。

- **controllers**
  外部とのインターフェースを実装します。
  ユースケースを呼び出し、入力データの受け渡しやレスポンスの整形を行います。

- **events**
  Discord の各種イベントハンドラ（例：クライアントの起動、メンバー追加、メッセージ受信など）を格納します。
  各イベントは個別ファイルに実装し、`eventHandler.ts` などでクライアントに登録される仕組みです。

- **repository**
  リポジトリのインターフェース（例：IMemberRepository）や、アプリケーションが利用するためのデータ抽象化を実装します。
  ※ インターフェース自体はドメインやアプリケーション層に配置し、実装は後述の infrastructure 層で実現するという依存性逆転の原則に基づいた設計を採用しています。

- **tasks**
  定期実行タスク（例：スケジュールされたチャンネル更新など）を実装します。
  アプリケーションの運用上必要なバックグラウンド処理をまとめています。

- **usecases**
  ユースケース層では、具体的なビジネスロジックや操作（例：メンバーの取得、登録、Discord アカウントの接続など）を実装します。
  ドメイン層のビジネスルールを利用しながら、リポジトリやその他サービスを組み合わせた処理を記述します。

---

### 2. domain

**概要:**
ドメイン層は、プロジェクトのビジネスルールの核となる部分です。
ここでは、永続化や外部サービスに依存しない、純粋なビジネスロジックやルール（エンティティ、値オブジェクト、ドメインサービスなど）を定義します。

**含まれるサブディレクトリ:**

- **entities**
  メンバー（Member）や部署（Department）など、ビジネスドメインを表現するエンティティの型や振る舞いを定義します。
  これにより、ビジネスルールを厳格に実装し、外部の実装詳細に依存しない設計を実現します。

- **roles**
  Discord Bot における各種ロール（例：administrator、authorized、unAuthorized、各学部のロールなど）の定義を格納します。
  1 ロールにつき 1 ファイルとすることで、ロールに関連するプロパティやルールを管理します。
  ※ 今後、冗長と判断された場合には統合や廃止の検討も行います。

- **types**
  ドメイン固有の型定義（例：認証データ、コマンドの型、カスタムクライアントやカスタムロールの型など）をまとめます。
  型安全性を高め、ビジネスロジックの一貫性を担保します。

---

### 3. infrastructure

**概要:**
インフラストラクチャ層は、データベース、外部サービス、ネットワーク通信などの技術的実装の詳細を担います。
ここでは、Prisma や Firebase など、永続化や外部サービス連携に必要な実装が含まれます。

**含まれるファイル:**

- **firebase.ts**
  Firebase 関連の初期化や接続処理を実装します。

- **prisma.ts**
  Prisma クライアントのインスタンスを生成し、データベースとの通信やクエリ実行のための設定を行います。

> **依存性について:**
> アプリケーション層やドメイン層は、インフラ層の具体的な実装に直接依存しないよう、リポジトリのインターフェースなどの抽象に依存します。
> このようにすることで、インフラの技術（例：Firebase から Prisma への移行など）変更時に、上位層に影響を与えずに対応できる設計となっています。

---

### 4. scripts

**概要:**
デプロイやコマンドのロードなど、プロジェクトの運用・管理に関するスクリプト群です。

**含まれるファイル:**

- **deployCommands.ts**
  Discord Bot に対してコマンドをデプロイするためのスクリプト。
  新たなコマンドを実装した際は、`npm run deploy-commands` でデプロイを実施します。

- **loadCommands.ts**
  Bot 起動時に、`application/commands` フォルダ内のコマンドをすべて読み込み、登録するためのスクリプトです。
  個別に実行する必要はなく、エントリポイントから自動的に呼び出されます。

---

### 5. utils

**概要:**
プロジェクト全体で利用する汎用的な機能・補助関数をまとめたユーティリティ層です。
どの層にも属さない共通処理をまとめることで、コードの重複を防ぎ再利用性を高めます。

---

### 6. Root Files

**主なファイル:**

- **main.ts**
  エントリポイントです。アプリケーション全体の初期化や、各層（application、infrastructure など）の連携処理を開始します。

---

## 依存関係の思想

- **依存性逆転の原則 (DIP):**
  上位層（ドメイン、アプリケーション）は、下位層（インフラストラクチャ）の具体的な実装に依存せず、抽象（リポジトリのインターフェースなど）に依存します。
  これにより、インフラの変更があった場合でも、上位層への影響を最小限に抑えられます。

- **レイヤードアーキテクチャ:**
  各層（ドメイン、アプリケーション、インフラストラクチャ）は明確に分離され、責務ごとに実装されます。
  ドメイン層はビジネスルールの核を担い、アプリケーション層はそのルールを使って具体的な処理を行い、インフラ層は外部システムとの接続を担います。

- **抽象と具象の分離:**
  リポジトリのインターフェースやユースケースは抽象レベルで定義し、実際の実装（例：Prisma や Firebase を用いた処理）はインフラストラクチャ層で実現することで、コードの保守性とテスト容易性を向上させます。
